\* TLC Model Checking Configuration for Safeguard
\* Run with: tlc Safeguard.tla -config Safeguard.cfg

\* ============================================================================
\* CONSTANT DEFINITIONS
\* ============================================================================

\* Small model for quick verification (< 1 minute)
CONSTANT
    USERS = {u1, u2, u3}
    ADMIN_ID = u1
    TOKEN_REFRESH_BUFFER = 5
    MAX_TOKEN_LIFETIME = 60
    MAX_THREADS = 2
    DEFAULT_BATCH_SIZE = 2
    BATCH_DELAY_MS = 1000
    CB_FAILURE_THRESHOLD = 3
    CB_FAILURE_RATIO = 50
    CB_SAMPLING_DURATION = 30
    CB_BREAK_DURATION = 30
    NULL = NULL
    MAX_TIME = 20

\* ============================================================================
\* SPECIFICATION
\* ============================================================================

SPECIFICATION Spec

\* ============================================================================
\* SAFETY INVARIANTS TO CHECK
\* ============================================================================

\* Type correctness
INVARIANT TypeOK

\* Critical: Admin never operates on themselves
INVARIANT AdminSelfProtection

\* No destructive operations without authentication
INVARIANT NoUnauthDestructive

\* Authentication implies user is set
INVARIANT AuthImpliesUser

\* Operation implies authenticated
INVARIANT OperationImpliesAuth

\* Degraded state implies circuit is open
INVARIANT DegradedImpliesCircuitOpen

\* Progress is bounded
INVARIANT ProgressBounded

\* ============================================================================
\* LIVENESS PROPERTIES TO CHECK
\* ============================================================================

\* Operations eventually complete
PROPERTY OperationsEventuallyComplete

\* Authentication eventually resolves
PROPERTY AuthEventuallyResolves

\* ============================================================================
\* STATE CONSTRAINT (limits state space for model checking)
\* ============================================================================

CONSTRAINT
    /\ now <= MAX_TIME
    /\ operationProgress <= 10
    /\ Len(auditLog) <= 20
    /\ Len(operationResults) <= 5

\* ============================================================================
\* SYMMETRY (reduces state space by treating users symmetrically)
\* ============================================================================

\* Note: Cannot use symmetry for ADMIN_ID since it has special behavior
\* SYMMETRY UserSymmetry

\* ============================================================================
\* ACTION CONSTRAINT (optional - limits exploration)
\* ============================================================================

\* Uncomment to focus on specific behaviors
\* ACTION_CONSTRAINT
\*     /\ ~(systemState = "Error")
